import{_ as z}from"./vBtn-LXvsT-fh.js";import{b as X,r as R,a as Z,B as K,h as Y,I as H,N as ee}from"./vant-BF4L1TGb.js";import{_ as te}from"./vantForm-CNH6TuWQ.js";import ae from"./designGroup-BundeY0U.js";import{r as ie,c as T,w as le,E as D,y as P,h as q,g as x,s as r,u as ne,e as se}from"./index-B7VWkQ_2.js";import{l}from"./lodash-DhpMPSDc.js";import{b as w,m as k}from"./makeSelect-CYTCxxsZ.js";import{a as _}from"./arrayToVantColumns-BXijbtnA.js";import{a as m,m as h}from"./makeTitle-CzVkaK9t.js";import{w as B}from"./watchItem-DUEI_3OU.js";import{x as oe}from"./xe-utils-DXe260hc.js";import{c as ce,u as re}from"./@vueuse-QQdVrKV8.js";import{m as I,a as F}from"./makeUpload-Du0F1yJj.js";import{m as ue}from"./makeForm-BmsmFLmR.js";import{r as pe}from"./runTime-DAjLGjV1.js";import{q as V}from"./queryUrl-BTYYWpY7.js";import{b as de}from"./backfill-BoX-74Dj.js";import{r as me,e as ve,b3 as U,aX as C,al as fe,N as n,bA as d,u as c,aj as $,ak as j,F as ye,V as O,be,am as he}from"./@vue-ts87NNlE.js";import"./wait-Dqho1LKt.js";import"./@vant-NmgEisJw.js";import"./pinia-B_HOjTBS.js";import"./vue-router-Bw4qQE88.js";import"./axios-B4uVmeYG.js";import"./@x-ui-vue3-CwLx_scX.js";import"./pinia-plugin-persist-J3Q2VqHx.js";import"./vue3-menus-CnNWMJEM.js";import"./vue3-photo-preview-CkWuweRQ.js";import"./vxe-table-QgdefRjh.js";import"./dom-zindex-GlLoxNk1.js";import"./@vue-office-GFDCm3nC.js";import"./vue-demi-BEcyFcst.js";import"./vue-RHKPHaPZ.js";import"./class-COLQ8iHP.js";const ge=[{formType:"",name:"designGroupShow",value:!1,backfill(e){this.value=!1},getParam(e){delete e[this.name]}},{formType:"",name:"completeNbqPv",value:!1,backfill(e){this.value=e[this.name]},getParam(e){e[this.name]=this.value}},{name:"id",value:"",backfill(e){this.value=e.id},getParam(e){e.id=this.value}},{name:"designIdByPv",value:"",backfill(e){this.value=e.designIdByPv},getParam(e){e.designIdByPv=this.value}}],qe=[{customSlot:"title",title:"基本信息",show:!1,click(){ie.push({path:"/designChangeLog",query:{orderId:T().orderId}})},onMounted(){this.show=T().title=="设计变更信息"}},{formType:"input",label:"设计类型",required:!0,value:"",name:"designType",...w(),...k("designType",_(["一字型","人字型","阵列式","一字型+人字型","一字型+阵列式","人字型+阵列式"]))},{formType:"input",label:"南坡组件数量",type:"digit",value:"",placeholder:"请输入",name:"southModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"北坡组件数量",type:"digit",value:"",placeholder:"请输入",name:"northModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"东坡组件数量",type:"digit",value:"",placeholder:"请输入",name:"eastModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"西坡组件数量",type:"digit",value:"",placeholder:"请输入",name:"westModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"是否有天窗",required:!0,value:"",name:"skyLight",...w(),...k("skyLight",[{text:"无",value:0},{text:"有",value:1}])},{formType:"input",label:"组件朝向",value:"",name:"moduleTowards",...w(),...k("moduleTowards",_(["正南","东南","西南","正西","正东","正北","东北","西北"]))},{formType:"input",label:"方位角",required:!0,value:"",type:"digit",name:"azimuthAngle",rules:[e=>(e*1>359||e*1<0)&&"只允许输入 0-360 (含0, 不含360) 之间的数字, 不允许输入小数点, 不允许输入其他字符或中文"],...m("度")},{formType:"input",label:"倾斜角",required:!0,value:"",type:"digit",name:"tiltAngle",rules:[e=>(e*1>89||e*1<0)&&"只允许输入 0-89 (含0, 不含89) 之间的数字, 不允许输入小数点, 不允许输入其他字符或中文"],...m("度")},{formType:"input",label:"安装最高点(房屋+光伏总高度)",required:!0,value:"",name:"installedHeight",rules:[e=>e<0&&"高度不能为负数"],...m("米")}],we=[h("组件"),{formType:"input",label:"设计组件功率",type:"digit",name:"deviceSpec",required:!0,...m("W"),backfill(e){const t=l.find(e.designDevice,["deviceType","ZUJIAN"]);this.value=l.get(t,this.name)}},{formType:"input",label:"设计组件数量",value:"",required:!0,type:"digit",name:"quantity",...m("块"),backfill(e){const t=l.find(e.designDevice,["deviceType","ZUJIAN"]);this.value=l.get(t,this.name)}},{formType:"input",label:"设计容量",placeholder:"自动计算",value:"",required:!0,readonly:!0,name:"installedCapacityDesign",...m("W"),backfill(){B(["deviceSpec","quantity"],([e,t])=>{const a=oe.multiply(e,t);this.realValue=a;const i=le(a);this.value=i.realValue,this.makeUnit(i.unit)})}},{formType:"input",label:"基底分类",required:!0,value:"",name:"moduleBaseType",...w(),...k("moduleBaseType",_(["N型组件","P型组件"]))},{formType:"input",label:"背板分类",required:!0,value:"",name:"moduleBackPlateType",...w(),...k("moduleBackPlateType",_(["双玻双面","单玻单面"]))},{name:"zj",getParam(e){l.isArray(e.designDevice)||(e.designDevice=[]);const t={deviceSpec:e.deviceSpec,quantity:e.quantity,deviceType:"ZUJIAN"};e.designDevice.push(t),delete e.deviceSpec,delete e.quantity}}],ke=[h("逆变器"),{formType:"input",label:"逆变器规格型号",type:"digit",name:"deviceSpec-nbq",value:"",...m("kW")},{formType:"input",label:"逆变器个数",type:"digit",name:"quantity-nbq",value:"",...m("个")},{formType:"cell",inputAlign:"center",titleClass:"xCenter",valueClass:"xCenter",name:"button-nbq",inlineForm:[{slot:"title",text:"添加",formType:"button",className:"bg-[#ddd] text-white h-8 w-[60%] rounded-2xl van-haptics-feedback ",disabled:!0,click(){const e=x("deviceSpec-nbq").value,t=x("quantity-nbq").value;r("table-nbq",a=>{a.value.push({deviceSpec:e+" kW",quantity:t});const i=l.groupBy(a.value,"deviceSpec"),u=l.mapValues(i,o=>l.sumBy(o,s=>s.quantity*1)),f=[];l.forIn(u,(o,s)=>{f.push({deviceSpec:s,quantity:o})}),a.value=f,r("deviceSpec-nbq","value",""),r("quantity-nbq","value",""),r("completeNbqPv","value",!1)})}},{slot:"value",text:"设计组串数量",formType:"button",className:"bg-[#ddd] text-white h-8 w-[60%] rounded-2xl van-haptics-feedback ",async click(){const e=ne();T().status!="不可变更"&&(await e.saveData(),await e.getData()),r("designGroupShow","value",!0);const a=P(),i=l.pick(a,["id","orderId","designIdByPv"]),f=l.filter(a.designDevice,["deviceType","NBQ"]).reduce((o,s)=>(s=`${s.deviceSpec}*${s.quantity} `,o+=s,o),"");r("designGroupShow","query",{...i,table:f})}}],backfill(){B(["deviceSpec-nbq","quantity-nbq"],([e,t])=>{const a=new Boolean(e?.length&&t?.length).valueOf(),i=a?"yellow":"disabled";this.inlineForm[0].disabled=!a,this.inlineForm[0].className=this.inlineForm[0].className.replace(/bg-[^ ]+/,`bg-${i}`)})}},{customSlot:"table-nbq",formType:"",name:"table-nbq",value:[],backfill(e){this.value=(e.designDevice||[]).filter(t=>t.deviceType=="NBQ"),this.value.forEach(t=>{t.deviceSpec=t.deviceSpec+" kW"}),ce(()=>{const t=this.value,i=new Boolean(t?.length).valueOf()?"yellow":"disabled";return r("button-nbq",u=>{u.inlineForm[1].className=u.inlineForm[1].className.replace(/bg-[^ ]+/,`bg-${i}`)}),this.value})},getParam(e){l.isArray(e.designDevice)||(e.designDevice=[]);const t=this.value.map(a=>{const i=l.clone(a);return i.deviceSpec=i.deviceSpec.replace(/(\d+).*/,"$1"),i.deviceType="NBQ",delete i._X_ROW_KEY,i});e.designDevice.push(...t),delete e["deviceSpec-nbq"],delete e["quantity-nbq"]},remove(e){const t=this.value.findIndex(a=>a.deviceSpec==e.deviceSpec);this.value.splice(t,1),r("completeNbqPv","value",!1)}}],xe=[h("采集器"),{formType:"input",label:"采集器个数",type:"digit",name:"deviceSpec-cjq",required:!0,value:"",...m("个"),backfill(e){const t=l.find(e.designDevice,["deviceType","CJQ"]);this.value=l.get(t,"quantity")},getParam(e){l.isArray(e.designDevice)||(e.designDevice=[]);const t={quantity:this.value,deviceType:"CJQ"};e.designDevice.push(t),delete e["deviceSpec-cjq"]}}],Te=[h("配电箱"),{formType:"input",label:"配电箱规格型号",type:"digit",name:"deviceSpec-pdx",value:"",...m("A")},{formType:"input",label:"配电箱个数",type:"digit",name:"quantity-pdx",value:"",...m("个")},{formType:"input",inputAlign:"center",inlineForm:[{slot:"input",text:"添加",formType:"button",className:"bg-[#ddd] text-white h-8 w-[30%] rounded-2xl van-haptics-feedback",disabled:!0,click(){const e=x("deviceSpec-pdx").value,t=x("quantity-pdx").value;r("table-pdx",a=>{a.value.push({deviceSpec:e+" A",quantity:t});const i=l.groupBy(a.value,"deviceSpec"),u=l.mapValues(i,o=>l.sumBy(o,s=>s.quantity*1)),f=[];l.forIn(u,(o,s)=>{f.push({deviceSpec:s,quantity:o})}),a.value=f,r("deviceSpec-pdx","value",""),r("quantity-pdx","value","")})}}],backfill(){B(["deviceSpec-pdx","quantity-pdx"],([e,t])=>{const a=new Boolean(e?.length&&t?.length).valueOf(),i=a?"yellow":"disabled";this.inlineForm[0].disabled=!a,this.inlineForm[0].className=this.inlineForm[0].className.replace(/bg-[^ ]+/,`bg-${i}`)})}},{customSlot:"table-pdx",formType:"",name:"table-pdx",value:[],backfill(e){this.value=(e.designDevice||[]).filter(t=>t.deviceType=="PDX"),this.value.forEach(t=>{t.deviceSpec=t.deviceSpec+" A"})},getParam(e){l.isArray(e.designDevice)||(e.designDevice=[]);const t=this.value.map(a=>{const i=l.clone(a);return i.deviceSpec=i.deviceSpec.replace(/(\d+).*/,"$1"),i.deviceType="PDX",delete i._X_ROW_KEY,i});e.designDevice.push(...t),delete e["deviceSpec-pdx"],delete e["quantity-pdx"]},remove(e){const t=this.value.findIndex(a=>a.deviceSpec==e.deviceSpec);this.value.splice(t,1)}}],_e=[h("结构图纸"),{...I(999,100,"*"),formType:"input",label:"结构图纸",required:!0,name:"structureChart",backfill(e){l.bind(F,this)(e)},getParam(e){e[this.name]=JSON.stringify(e[this.name].map(t=>D(t)))}}],Se=[h("电气图纸"),{...I(999,100,"*"),formType:"input",label:"电气图纸",required:!0,name:"electricalDiagram",backfill(e){l.bind(F,this)(e)},getParam(e){e[this.name]=JSON.stringify(e[this.name].map(t=>D(t)))}}],Ne=[h("物料清单"),{label:"(BOM) 物料清单",name:"materialList",...I(999,100,"*",!1,!1),backfill(e){l.bind(F,this)(e)},getParam(e){e[this.name]=e[this.name].map(t=>D(t))}},{formType:"input",inputAlign:"center",name:"saveMaterial",inlineForm:[{slot:"input",text:"只保存物料清单",formType:"button",className:"bg-yellow text-white h-8 w-[30%] rounded-2xl van-haptics-feedback",async click(e=!0){const t=l.pick(P(),["id","orderId","materialList"]);(await q.post("design/update-material",t)).code==200&&e&&X("保存物料清单成功")}}]}],Ce={class:"flex justify-end"},ct={__name:"InitialReview",setup(e){const t=ue({basicInfoForm:qe,zj:we,nbq:ke,cjq:xe,pdx:Te,structureChartForm:_e,electricalDiagramForm:Se,billMaterials:Ne,show:ge}),a=T(),i=me(null);ve(()=>{pe(u),re(a.title)});async function u(){const v=V("order/get-design",{times:a.title=="初设评审信息"?0:100,...a}),{data:g}=await q.get(v);de(t,g)}async function f(){const v=P();return r("saveMaterial",S=>{S.inlineForm[0].click(!1)}),await q.post("order/put-design",v)}function o(){t.show[0].value=!1,u()}async function s(v){if(v.completeNbqPv=x("completeNbqPv","value"),!v.completeNbqPv){Z("设计组串数量中PV1、PV2 的 DC1 是必填、非零项");return}await q.post(V("approval/put-approval/bto/design",v))}async function E(v){await q.post("approval/do-approval/bto/design",v)}return se({getData:u,saveData:f,submitData:s,approvalData:E}),(v,g)=>{const S=K,J=Y,y=te,b=U("vxe-column"),A=H,M=U("vxe-table"),L=ee,Q=R,W=z;return C(),fe(ye,null,[n(y,{form:c(t).basicInfoForm,class:"pt-3","group-class":"shadowC"},{title:d(({slot:p})=>[n(J,{"title-class":"!text-[20px] bg-[#fff] pl-[20px] flex items-center  text-[#232323]",class:"!bg-[#fff] !p-0 h-[50px] !pr-[20px]"},{title:d(()=>[O(be(p.title),1)]),value:d(()=>[he("div",Ce,[p.show?(C(),$(S,{key:0,round:"",block:"",size:"mini",class:"!text-[14px] !w-[120px] !py-3 !bg-[#ffab30] !border-0 !text-[white]",onClick:()=>p.click()},{default:d(()=>[O(" 设计变更记录 ")]),_:2},1032,["onClick"])):j("",!0)])]),_:2},1024)]),_:1},8,["form"]),n(y,{form:c(t).zj,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(y,{form:c(t).nbq,class:"pt-3","group-class":"shadowC pb-9"},{"table-nbq":d(({slot:p})=>[n(M,{data:p.value,align:"center","header-align":"center"},{default:d(()=>[n(b,{type:"seq",width:"60",title:"序号"}),n(b,{field:"deviceSpec",title:"规格型号"}),n(b,{field:"quantity",title:"个数",width:"60"}),n(b,{field:"",title:"操作",width:"60"},{default:d(({row:N})=>[n(A,{name:"cross",color:"red",onClick:G=>p.remove(N)},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])]),_:1},8,["form"]),n(y,{form:c(t).cjq,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(y,{form:c(t).pdx,class:"pt-3","group-class":"shadowC pb-9"},{"table-pdx":d(({slot:p})=>[n(M,{data:p.value,align:"center","header-align":"center"},{default:d(()=>[n(b,{type:"seq",width:"60",title:"序号"}),n(b,{field:"deviceSpec",title:"规格型号"}),n(b,{field:"quantity",title:"个数",width:"60"}),n(b,{field:"",title:"操作",width:"60"},{default:d(({row:N})=>[n(A,{name:"cross",color:"red",onClick:G=>p.remove(N)},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])]),_:1},8,["form"]),n(y,{form:c(t).structureChartForm,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(y,{form:c(t).electricalDiagramForm,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(y,{form:c(t).billMaterials,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(Q,{show:c(t).show[0].value,"onUpdate:show":g[0]||(g[0]=p=>c(t).show[0].value=p),position:"right",class:"w-full h-full"},{default:d(()=>[n(L,{title:"设计组串数量","left-text":"返回",onClickLeft:o}),n(ae,{ref_key:"designGroupDom",ref:i,query:c(t).show[0].query},null,8,["query"])]),_:1},8,["show"]),c(a).status!="不可变更"?(C(),$(W,{key:0})):j("",!0)],64)}}};export{ct as default};
