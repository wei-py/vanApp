import{_ as z}from"./vBtn-TO34BCEa.js";import{b as X,f as R,a as Z,B as K,o as Y,t as H,N as ee}from"./vant-BjNCsb4u.js";import{m as te,_ as ae}from"./makeForm-B3HhMcgC.js";import ie from"./designGroup-PDa-OVMB.js";import{r as le,c as D,t as ne,D as C,x as P,h as q,g as x,s as r,u as se,e as oe}from"./index-L-kxfX5L.js";import{l}from"./lodash-DhpMPSDc.js";import{b as w,m as k}from"./makeSelect-CelQ3_Nu.js";import{a as T}from"./arrayToVantColumns-BXijbtnA.js";import{a as p,m as g,b as ce}from"./backfill-xLooAZ69.js";import{w as B}from"./watchItem-D1B295P1.js";import{x as re}from"./xe-utils-DXe260hc.js";import{c as ue,u as de}from"./@vueuse-QQdVrKV8.js";import{m as F,a as I}from"./makeUpload-BbIDm5Yp.js";import{r as pe}from"./runTime-DAjLGjV1.js";import{q as V}from"./queryUrl-BTYYWpY7.js";import{r as me,e as ve,b3 as U,aX as N,al as fe,N as n,bA as d,u as c,aj as $,ak as j,F as ye,V as O,be,am as ge}from"./@vue-ts87NNlE.js";import"./wait-Dqho1LKt.js";import"./@vant-NmgEisJw.js";import"./pinia-B_HOjTBS.js";import"./vue-router-Bw4qQE88.js";import"./axios-B4uVmeYG.js";import"./@x-ui-vue3-CwLx_scX.js";import"./pinia-plugin-persist-J3Q2VqHx.js";import"./vue3-menus-CnNWMJEM.js";import"./vue3-photo-preview-CkWuweRQ.js";import"./vxe-table-QgdefRjh.js";import"./dom-zindex-GlLoxNk1.js";import"./@vue-office-GFDCm3nC.js";import"./vue-demi-BEcyFcst.js";import"./vue-RHKPHaPZ.js";import"./class-COLQ8iHP.js";const he=[{formType:"",name:"designGroupShow",value:!1,backfill(e){this.value=!1},getParam(e){delete e[this.name]}},{formType:"",name:"completeNbqPv",value:!1,backfill(e){this.value=e[this.name]},getParam(e){e[this.name]=this.value}},{name:"id",value:"",backfill(e){this.value=e.id},getParam(e){e.id=this.value}},{name:"designIdByPv",value:"",backfill(e){this.value=e.designIdByPv},getParam(e){e.designIdByPv=this.value}}],qe=[{customSlot:"title",title:"基本信息",show:!1,click(){le.push({path:"/designChangeLog",query:{orderId:D().orderId}})},onMounted(){this.show=D().title=="设计变更信息"}},{formType:"input",label:"设计类型",required:!0,value:"",name:"designType",...w(),...k("designType",T(["一字型","人字型","阵列式","一字型+人字型","一字型+阵列式","人字型+阵列式"]))},{formType:"input",label:"南坡组件数量",type:"digit",value:"",placeholder:"请输入",name:"southModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"北坡组件数量",type:"digit",value:"",placeholder:"请输入",name:"northModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"东坡组件数量",type:"digit",value:"",placeholder:"请输入",name:"eastModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"西坡组件数量",type:"digit",value:"",placeholder:"请输入",name:"westModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"是否有天窗",required:!0,value:"",name:"skyLight",...w(),...k("skyLight",[{text:"无",value:0},{text:"有",value:1}])},{formType:"input",label:"组件朝向",value:"",name:"moduleTowards",...w(),...k("moduleTowards",T(["正南","东南","西南","正西","正东","正北","东北","西北"]))},{formType:"input",label:"方位角",required:!0,value:"",type:"digit",name:"azimuthAngle",rules:[e=>(e*1>359||e*1<0)&&"只允许输入 0-360 (含0, 不含360) 之间的数字, 不允许输入小数点, 不允许输入其他字符或中文"],...p("度")},{formType:"input",label:"倾斜角",required:!0,value:"",type:"digit",name:"tiltAngle",rules:[e=>(e*1>89||e*1<0)&&"只允许输入 0-89 (含0, 不含89) 之间的数字, 不允许输入小数点, 不允许输入其他字符或中文"],...p("度")},{formType:"input",label:"安装最高点(房屋+光伏总高度)",required:!0,value:"",name:"installedHeight",rules:[e=>e<0&&"高度不能为负数"],...p("米")}],we=[g("组件"),{formType:"input",label:"设计组件功率",type:"digit",name:"deviceSpec",required:!0,...p("W"),backfill(e){const t=l.find(e.designDevice,["deviceType","ZUJIAN"]);this.value=l.get(t,this.name)}},{formType:"input",label:"设计组件数量",value:"",required:!0,type:"digit",name:"quantity",...p("块"),backfill(e){const t=l.find(e.designDevice,["deviceType","ZUJIAN"]);this.value=l.get(t,this.name)}},{formType:"input",label:"设计容量",placeholder:"自动计算",value:"",required:!0,readonly:!0,name:"installedCapacityDesign",...p("W"),backfill(){B(["deviceSpec","quantity"],([e,t])=>{const a=re.multiply(e,t);this.realValue=a;const i=ne(a);this.value=i.realValue,this.makeUnit(i.unit)})}},{formType:"input",label:"基底分类",required:!0,value:"",name:"moduleBaseType",...w(),...k("moduleBaseType",T(["N型组件","P型组件"]))},{formType:"input",label:"背板分类",required:!0,value:"",name:"moduleBackPlateType",...w(),...k("moduleBackPlateType",T(["双玻双面","单玻单面"]))},{name:"zj",getParam(e){l.isArray(e.designDevice)||(e.designDevice=[]);const t={deviceSpec:e.deviceSpec,quantity:e.quantity,deviceType:"ZUJIAN"};e.designDevice.push(t),delete e.deviceSpec,delete e.quantity}}],ke=[g("逆变器"),{formType:"input",label:"逆变器规格型号",type:"digit",name:"deviceSpec-nbq",value:"",...p("kW")},{formType:"input",label:"逆变器个数",type:"digit",name:"quantity-nbq",value:"",...p("个")},{formType:"cell",inputAlign:"center",titleClass:"xCenter",valueClass:"xCenter",name:"button-nbq",inlineForm:[{slot:"title",text:"添加",formType:"button",className:"bg-[#ddd] text-white h-8 w-[60%] rounded-2xl van-haptics-feedback ",disabled:!0,click(){const e=x("deviceSpec-nbq").value,t=x("quantity-nbq").value;r("table-nbq",a=>{a.value.push({deviceSpec:e+" kW",quantity:t});const i=l.groupBy(a.value,"deviceSpec"),o=l.mapValues(i,s=>l.sumBy(s,f=>f.quantity*1)),m=[];l.forIn(o,(s,f)=>{m.push({deviceSpec:f,quantity:s})}),a.value=m,r("deviceSpec-nbq","value",""),r("quantity-nbq","value",""),r("completeNbqPv","value",!1)})}},{slot:"value",text:"设计组串数量",formType:"button",className:"bg-[#ddd] text-white h-8 w-[60%] rounded-2xl van-haptics-feedback ",async click(){const e=se();await e.saveData(),await e.getData(),r("designGroupShow","value",!0);const t=P(),a=l.pick(t,["id","orderId","designIdByPv"]),o=l.filter(t.designDevice,["deviceType","NBQ"]).reduce((m,s)=>(s=`${s.deviceSpec}*${s.quantity} `,m+=s,m),"");r("designGroupShow","query",{...a,table:o})}}],backfill(){B(["deviceSpec-nbq","quantity-nbq"],([e,t])=>{const a=new Boolean(e?.length&&t?.length).valueOf(),i=a?"yellow":"disabled";this.inlineForm[0].disabled=!a,this.inlineForm[0].className=this.inlineForm[0].className.replace(/bg-[^ ]+/,`bg-${i}`)})}},{customSlot:"table-nbq",formType:"",name:"table-nbq",value:[],backfill(e){this.value=(e.designDevice||[]).filter(t=>t.deviceType=="NBQ"),this.value.forEach(t=>{t.deviceSpec=t.deviceSpec+" kW"}),ue(()=>{const t=this.value,i=new Boolean(t?.length).valueOf()?"yellow":"disabled";return r("button-nbq",o=>{o.inlineForm[1].className=o.inlineForm[1].className.replace(/bg-[^ ]+/,`bg-${i}`)}),this.value})},getParam(e){l.isArray(e.designDevice)||(e.designDevice=[]);const t=this.value.map(a=>{const i=l.clone(a);return i.deviceSpec=i.deviceSpec.replace(/(\d+).*/,"$1"),i.deviceType="NBQ",delete i._X_ROW_KEY,i});e.designDevice.push(...t),delete e["deviceSpec-nbq"],delete e["quantity-nbq"]},remove(e){const t=this.value.findIndex(a=>a.deviceSpec==e.deviceSpec);this.value.splice(t,1),r("completeNbqPv","value",!1)}}],xe=[g("采集器"),{formType:"input",label:"采集器个数",type:"digit",name:"deviceSpec-cjq",required:!0,value:"",...p("个"),backfill(e){const t=l.find(e.designDevice,["deviceType","CJQ"]);this.value=l.get(t,"quantity")},getParam(e){l.isArray(e.designDevice)||(e.designDevice=[]);const t={quantity:this.value,deviceType:"CJQ"};e.designDevice.push(t),delete e["deviceSpec-cjq"]}}],Te=[g("配电箱"),{formType:"input",label:"配电箱规格型号",type:"digit",name:"deviceSpec-pdx",value:"",...p("A")},{formType:"input",label:"配电箱个数",type:"digit",name:"quantity-pdx",value:"",...p("个")},{formType:"input",inputAlign:"center",inlineForm:[{slot:"input",text:"添加",formType:"button",className:"bg-[#ddd] text-white h-8 w-[30%] rounded-2xl van-haptics-feedback",disabled:!0,click(){const e=x("deviceSpec-pdx").value,t=x("quantity-pdx").value;r("table-pdx",a=>{a.value.push({deviceSpec:e+" A",quantity:t});const i=l.groupBy(a.value,"deviceSpec"),o=l.mapValues(i,s=>l.sumBy(s,f=>f.quantity*1)),m=[];l.forIn(o,(s,f)=>{m.push({deviceSpec:f,quantity:s})}),a.value=m,r("deviceSpec-pdx","value",""),r("quantity-pdx","value","")})}}],backfill(){B(["deviceSpec-pdx","quantity-pdx"],([e,t])=>{const a=new Boolean(e?.length&&t?.length).valueOf(),i=a?"yellow":"disabled";this.inlineForm[0].disabled=!a,this.inlineForm[0].className=this.inlineForm[0].className.replace(/bg-[^ ]+/,`bg-${i}`)})}},{customSlot:"table-pdx",formType:"",name:"table-pdx",value:[],backfill(e){this.value=(e.designDevice||[]).filter(t=>t.deviceType=="PDX"),this.value.forEach(t=>{t.deviceSpec=t.deviceSpec+" A"})},getParam(e){l.isArray(e.designDevice)||(e.designDevice=[]);const t=this.value.map(a=>{const i=l.clone(a);return i.deviceSpec=i.deviceSpec.replace(/(\d+).*/,"$1"),i.deviceType="PDX",delete i._X_ROW_KEY,i});e.designDevice.push(...t),delete e["deviceSpec-pdx"],delete e["quantity-pdx"]},remove(e){const t=this.value.findIndex(a=>a.deviceSpec==e.deviceSpec);this.value.splice(t,1)}}],_e=[g("结构图纸"),{...F(999,100,"*"),formType:"input",label:"结构图纸",required:!0,name:"structureChart",backfill(e){l.bind(I,this)(e)},getParam(e){e[this.name]=JSON.stringify(e[this.name].map(t=>C(t)))}}],Se=[g("电气图纸"),{...F(999,100,"*"),formType:"input",label:"电气图纸",required:!0,name:"electricalDiagram",backfill(e){l.bind(I,this)(e)},getParam(e){e[this.name]=JSON.stringify(e[this.name].map(t=>C(t)))}}],Ne=[g("物料清单"),{label:"(BOM) 物料清单",name:"materialList",...F(999,100,"*",!1,!1),backfill(e){l.bind(I,this)(e)},getParam(e){e[this.name]=e[this.name].map(t=>C(t))}},{formType:"input",inputAlign:"center",name:"saveMaterial",inlineForm:[{slot:"input",text:"只保存物料清单",formType:"button",className:"bg-yellow text-white h-8 w-[30%] rounded-2xl van-haptics-feedback",async click(e=!0){const t=l.pick(P(),["id","orderId","materialList"]);(await q.post("design/update-material",t)).code==200&&e&&X("保存物料清单成功")}}]}],De={class:"flex justify-end"},st={__name:"InitialReview",setup(e){const t=te({basicInfoForm:qe,zj:we,nbq:ke,cjq:xe,pdx:Te,structureChartForm:_e,electricalDiagramForm:Se,billMaterials:Ne,show:he}),a=D(),i=me(null);ve(()=>{pe(o),de(a.title)});async function o(){const v=V("order/get-design",{times:a.title=="初设评审信息"?0:100,...a}),{data:h}=await q.get(v);ce(t,h)}async function m(){const v=P();return r("saveMaterial",_=>{_.inlineForm[0].click(!1)}),await q.post("order/put-design",v)}function s(){t.show[0].value=!1,o()}async function f(v){if(v.completeNbqPv=x("completeNbqPv","value"),!v.completeNbqPv){Z("设计组串数量中PV1、PV2 的 DC1 是必填、非零项");return}await q.post(V("approval/put-approval/bto/design",v))}async function J(v){await q.post("approval/do-approval/bto/design",v)}return oe({getData:o,saveData:m,submitData:f,approvalData:J}),(v,h)=>{const _=K,L=Y,y=ae,b=U("vxe-column"),A=H,M=U("vxe-table"),Q=ee,W=R,E=z;return N(),fe(ye,null,[n(y,{form:c(t).basicInfoForm,class:"pt-3","group-class":"shadowC"},{title:d(({slot:u})=>[n(L,{"title-class":"!text-[20px] bg-[#fff] pl-[20px] flex items-center  text-[#232323]",class:"!bg-[#fff] !p-0 h-[50px] !pr-[20px]"},{title:d(()=>[O(be(u.title),1)]),value:d(()=>[ge("div",De,[u.show?(N(),$(_,{key:0,round:"",block:"",size:"mini",class:"!text-[14px] !w-[120px] !py-3 !bg-[#ffab30] !border-0 !text-[white]",onClick:()=>u.click()},{default:d(()=>[O(" 设计变更记录 ")]),_:2},1032,["onClick"])):j("",!0)])]),_:2},1024)]),_:1},8,["form"]),n(y,{form:c(t).zj,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(y,{form:c(t).nbq,class:"pt-3","group-class":"shadowC pb-9"},{"table-nbq":d(({slot:u})=>[n(M,{data:u.value,align:"center","header-align":"center"},{default:d(()=>[n(b,{type:"seq",width:"60",title:"序号"}),n(b,{field:"deviceSpec",title:"规格型号"}),n(b,{field:"quantity",title:"个数",width:"60"}),n(b,{field:"",title:"操作",width:"60"},{default:d(({row:S})=>[n(A,{name:"cross",color:"red",onClick:G=>u.remove(S)},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])]),_:1},8,["form"]),n(y,{form:c(t).cjq,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(y,{form:c(t).pdx,class:"pt-3","group-class":"shadowC pb-9"},{"table-pdx":d(({slot:u})=>[n(M,{data:u.value,align:"center","header-align":"center"},{default:d(()=>[n(b,{type:"seq",width:"60",title:"序号"}),n(b,{field:"deviceSpec",title:"规格型号"}),n(b,{field:"quantity",title:"个数",width:"60"}),n(b,{field:"",title:"操作",width:"60"},{default:d(({row:S})=>[n(A,{name:"cross",color:"red",onClick:G=>u.remove(S)},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])]),_:1},8,["form"]),n(y,{form:c(t).structureChartForm,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(y,{form:c(t).electricalDiagramForm,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(y,{form:c(t).billMaterials,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(W,{show:c(t).show[0].value,"onUpdate:show":h[0]||(h[0]=u=>c(t).show[0].value=u),position:"right",class:"w-full h-full"},{default:d(()=>[n(Q,{title:"设计组串数量","left-text":"返回",onClickLeft:s}),n(ie,{ref_key:"designGroupDom",ref:i,query:c(t).show[0].query},null,8,["query"])]),_:1},8,["show"]),c(a).status!="不可变更"?(N(),$(E,{key:0})):j("",!0)],64)}}};export{st as default};
