import{_ as W}from"./vBtn-CFSnyGjN.js";import{b as G,f as z,a as E,B as L,o as X,t as R}from"./vant-PdAvEskO.js";import{m as Z,_ as K}from"./makeForm-LXfxxl4j.js";import Y from"./designGroup-DYcLZC9k.js";import{r as H,c as N,q as ee,B as C,v as D,h as q,g as k,s as r,e as te}from"./index-D0ldpvYI.js";import{l as i}from"./lodash-D-SkTV7p.js";import{b as T,m as w}from"./makeSelect-C4yghakN.js";import{a as x}from"./arrayToVantColumns-BXijbtnA.js";import{a as d,m as h,b as ae}from"./backfill-YTqXYfvZ.js";import{w as P}from"./watchItem-CNvzLEiB.js";import{x as le}from"./xe-utils-CfMIR_ol.js";import{c as ie,u as ne}from"./@vueuse-DLUPp4BS.js";import{m as B,a as F}from"./makeUpload-BNh7QOMX.js";import{r as se}from"./runTime-DAjLGjV1.js";import{q as M}from"./queryUrl-DaTGvNW7.js";import{r as oe,e as re,b3 as U,aX as $,al as ce,N as n,bA as u,u as p,F as ue,V,be as pe,am as de,aj as me,ak as ve}from"./@vue-ts87NNlE.js";import"./@vant-NmgEisJw.js";import"./pinia-B_HOjTBS.js";import"./vue-router-Bw4qQE88.js";import"./axios-B6xwUs71.js";import"./@x-ui-vue3-CwLx_scX.js";import"./pinia-plugin-persist-J3Q2VqHx.js";import"./vue3-menus-CnNWMJEM.js";import"./vue3-photo-preview-jb8ML41u.js";import"./vxe-table-CAWzlaHI.js";import"./dom-zindex-GlLoxNk1.js";import"./@vue-office-D7CPqAIZ.js";import"./vue-demi-BO4xsXkA.js";import"./vue-B7fnMq6U.js";import"./class-COLQ8iHP.js";const fe=[{formType:"",name:"designGroupShow",value:!1,backfill(e){this.value=!1},getParam(e){delete e[this.name]}},{formType:"",name:"completeNbqPv",value:!1,backfill(e){this.value=e[this.name]},getParam(e){e[this.name]=this.value}},{name:"id",value:"",backfill(e){this.value=e.id},getParam(e){e.id=this.value}},{name:"designIdByPv",value:"",backfill(e){this.value=e.designIdByPv},getParam(e){e.designIdByPv=this.value}}],be=[{customSlot:"title",title:"基本信息",show:!1,click(){H.push({path:"/designChangeLog",query:{orderId:N().orderId}})},onMounted(){this.show=N().title=="设计变更信息"}},{formType:"input",label:"设计类型",required:!0,value:"",name:"designType",...T(),...w("designType",x(["一字型","人字型","阵列式","一字型+人字型","一字型+阵列式","人字型+阵列式"])),backfill(e){this.value=e.designType||"",this.realValue=e.designType||""},getParam(e){e.designType=""}},{formType:"input",label:"南坡组件数量",value:"",type:"number",placeholder:"请输入",name:"southModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"北坡组件数量",value:"",type:"number",placeholder:"请输入",name:"northModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"东坡组件数量",value:"",type:"number",placeholder:"请输入",name:"eastModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"西坡组件数量",value:"",type:"number",placeholder:"请输入",name:"westModuleNumber",rules:[e=>e<0&&"请输入正整数或 0"]},{formType:"input",label:"是否有天窗",required:!0,value:"",name:"skyLight",...T(),...w("skyLight",[{text:"无",value:0},{text:"有",value:1}])},{formType:"input",label:"组件朝向",value:"",name:"moduleTowards",...T(),...w("moduleTowards",x(["正南","东南","西南","正西","正东","正北","东北","西北"]))},{formType:"input",label:"方位角",required:!0,value:"",type:"number",name:"azimuthAngle",rules:[e=>(e*1>359||e*1<0)&&"只允许输入 0-360 (含0, 不含360) 之间的数字, 不允许输入小数点, 不允许输入其他字符或中文"],...d("度")},{formType:"input",label:"倾斜角",required:!0,value:"0",type:"number",name:"tiltAngle",rules:[e=>(e*1>89||e*1<0)&&"只允许输入 0-89 (含0, 不含89) 之间的数字, 不允许输入小数点, 不允许输入其他字符或中文"],...d("度")},{formType:"input",label:"安装最高点(房屋+光伏总高度)",required:!0,value:"",type:"digit",name:"installedHeight",rules:[e=>e<0&&"高度不能为负数"],...d("米")}],ye=[h("组件"),{formType:"input",label:"设计组件功率",type:"digit",name:"deviceSpec",required:!0,...d("W"),backfill(e){const t=i.find(e.designDevice,["deviceType","ZUJIAN"]);this.value=i.get(t,this.name)}},{formType:"input",label:"设计组件数量",value:"",required:!0,type:"number",name:"quantity",...d("块"),backfill(e){const t=i.find(e.designDevice,["deviceType","ZUJIAN"]);this.value=i.get(t,this.name)}},{formType:"input",label:"设计容量",placeholder:"自动计算",value:"",required:!0,readonly:!0,type:"digit",name:"installedCapacityDesign",...d("W"),backfill(){P(["deviceSpec","quantity"],([e,t])=>{const a=le.multiply(e,t);this.realValue=a;const l=ee(a);this.value=l.value,this.makeUnit(l.unit)})}},{formType:"input",label:"基底分类",required:!0,value:"",name:"moduleBaseType",...T(),...w("moduleBaseType",x(["N型组件","P型组件"]))},{formType:"input",label:"背板分类",required:!0,value:"",name:"moduleBackPlateType",...T(),...w("moduleBackPlateType",x(["双玻双面","单玻单面"]))},{name:"zj",getParam(e){i.isArray(e.designDevice)||(e.designDevice=[]);const t={deviceSpec:e.deviceSpec,quantity:e.quantity,deviceType:"ZUJIAN"};e.deviceSpec&&e.quantity&&e.designDevice.push(t),delete e.deviceSpec,delete e.quantity}}],he=[h("逆变器"),{formType:"input",label:"逆变器规格型号",type:"number",name:"deviceSpec-nbq",value:"",...d("kW")},{formType:"input",label:"逆变器个数",type:"number",name:"quantity-nbq",value:"",...d("个")},{formType:"cell",inputAlign:"center",titleClass:"xCenter",valueClass:"xCenter",name:"button-nbq",inlineForm:[{slot:"title",text:"添加",formType:"button",className:"bg-[#ddd] text-white h-8 w-[60%] rounded-2xl van-haptics-feedback ",disabled:!0,click(){const e=k("deviceSpec-nbq").value,t=k("quantity-nbq").value;r("table-nbq",a=>{a.value.push({deviceSpec:e+" kW",quantity:t});const l=i.groupBy(a.value,"deviceSpec"),s=i.mapValues(l,v=>i.sumBy(v,f=>f.quantity*1)),o=[];i.forIn(s,(v,f)=>{o.push({deviceSpec:f,quantity:v})}),a.value=o,r("deviceSpec-nbq","value",""),r("quantity-nbq","value",""),r("completeNbqPv","value",!1)})}},{slot:"value",text:"设计组串数量",formType:"button",className:"bg-[#ddd] text-white h-8 w-[60%] rounded-2xl van-haptics-feedback ",click(){r("designGroupShow","value",!0);const e=D(),t=i.pick(e,["id","orderId","designIdByPv"]),l=i.filter(e.designDevice,["deviceType","NBQ"]).reduce((s,o)=>(o=`${o.deviceSpec}*${o.quantity} `,s+=o,s),"");r("designGroupShow","query",{...t,table:l})}}],backfill(){P(["deviceSpec-nbq","quantity-nbq"],([e,t])=>{const a=new Boolean(e?.length&&t?.length).valueOf(),l=a?"yellow":"disabled";this.inlineForm[0].disabled=!a,this.inlineForm[0].className=this.inlineForm[0].className.replace(/bg-[^ ]+/,`bg-${l}`)})}},{customSlot:"table-nbq",formType:"",name:"table-nbq",value:[],backfill(e){this.value=(e.designDevice||[]).filter(t=>t.deviceType=="NBQ"),this.value.forEach(t=>{t.deviceSpec=t.deviceSpec+" kW"}),ie(()=>{const t=this.value,l=new Boolean(t?.length).valueOf()?"yellow":"disabled";return r("button-nbq",s=>{s.inlineForm[1].className=s.inlineForm[1].className.replace(/bg-[^ ]+/,`bg-${l}`)}),this.value})},getParam(e){i.isArray(e.designDevice)||(e.designDevice=[]);const t=this.value.map(a=>{const l=i.clone(a);return l.deviceSpec=l.deviceSpec.replace(/(\d+).*/,"$1"),l.deviceType="NBQ",delete l._X_ROW_KEY,l});e.designDevice.push(...t),delete e["deviceSpec-nbq"],delete e["quantity-nbq"]},remove(e){const t=this.value.findIndex(a=>a.deviceSpec==e.deviceSpec);this.value.splice(t,1),r("completeNbqPv","value",!1)}}],ge=[h("采集器"),{formType:"input",label:"采集器个数",type:"number",name:"deviceSpec-cjq",required:!0,value:"",...d("个"),backfill(e){const t=i.find(e.designDevice,["deviceType","CJQ"]);this.value=i.get(t,"quantity")},getParam(e){i.isArray(e.designDevice)||(e.designDevice=[]);const t={quantity:this.value,deviceType:"CJQ"};e.designDevice.push(t),delete e["deviceSpec-cjq"]}}],qe=[h("配电箱"),{formType:"input",label:"配电箱规格型号",type:"number",name:"deviceSpec-pdx",value:"",...d("A")},{formType:"input",label:"配电箱个数",type:"number",name:"quantity-pdx",value:"",...d("个")},{formType:"input",inputAlign:"center",inlineForm:[{slot:"input",text:"添加",formType:"button",className:"bg-[#ddd] text-white h-8 w-[30%] rounded-2xl van-haptics-feedback",disabled:!0,click(){const e=k("deviceSpec-pdx").value,t=k("quantity-pdx").value;r("table-pdx",a=>{a.value.push({deviceSpec:e+" A",quantity:t});const l=i.groupBy(a.value,"deviceSpec"),s=i.mapValues(l,v=>i.sumBy(v,f=>f.quantity*1)),o=[];i.forIn(s,(v,f)=>{o.push({deviceSpec:f,quantity:v})}),a.value=o,r("deviceSpec-pdx","value",""),r("quantity-pdx","value","")})}}],backfill(){P(["deviceSpec-pdx","quantity-pdx"],([e,t])=>{const a=new Boolean(e?.length&&t?.length).valueOf(),l=a?"yellow":"disabled";this.inlineForm[0].disabled=!a,this.inlineForm[0].className=this.inlineForm[0].className.replace(/bg-[^ ]+/,`bg-${l}`)})}},{customSlot:"table-pdx",formType:"",name:"table-pdx",value:[],backfill(e){this.value=(e.designDevice||[]).filter(t=>t.deviceType=="PDX"),this.value.forEach(t=>{t.deviceSpec=t.deviceSpec+" A"})},getParam(e){i.isArray(e.designDevice)||(e.designDevice=[]);const t=this.value.map(a=>{const l=i.clone(a);return l.deviceSpec=l.deviceSpec.replace(/(\d+).*/,"$1"),l.deviceType="PDX",delete l._X_ROW_KEY,l});e.designDevice.push(...t),delete e["deviceSpec-pdx"],delete e["quantity-pdx"]},remove(e){const t=this.value.findIndex(a=>a.deviceSpec==e.deviceSpec);this.value.splice(t,1)}}],Te=[h("结构图纸"),{...B(999,100,"*"),formType:"input",label:"结构图纸",required:!0,name:"structureChart",backfill(e){i.bind(F,this)(e)},getParam(e){e[this.name]=JSON.stringify(e[this.name].map(t=>C(t)))}}],we=[h("电气图纸"),{...B(999,100,"*"),formType:"input",label:"电气图纸",required:!0,name:"electricalDiagram",backfill(e){i.bind(F,this)(e)},getParam(e){e[this.name]=JSON.stringify(e[this.name].map(t=>C(t)))}}],ke=[h("物料清单"),{label:"(BOM) 物料清单",name:"materialList",...B(999,100,"*",!1,!1),backfill(e){i.bind(F,this)(e)},getParam(e){e[this.name]=e[this.name].map(t=>C(t))}},{formType:"input",inputAlign:"center",name:"saveMaterial",inlineForm:[{slot:"input",text:"只保存物料清单",formType:"button",className:"bg-yellow text-white h-8 w-[30%] rounded-2xl van-haptics-feedback",async click(e=!0){const t=i.pick(D(),["id","orderId","materialList"]);(await q.post("design/update-material",t)).code==200&&e&&G("保存物料清单成功")}}]}],xe={class:"flex justify-end"},tt={__name:"InitialReview",setup(e){const t=Z({basicInfoForm:be,zj:ye,nbq:he,cjq:ge,pdx:qe,structureChartForm:Te,electricalDiagramForm:we,billMaterials:ke,show:fe}),a=N(),l=oe(null);re(()=>{se(s),ne(a.title)});async function s(){const m=M("order/get-design",{times:a.title=="初设评审信息"?0:100,...a}),{data:g}=await q.get(m);ae(t,g)}async function o(){const m=D();return r("saveMaterial",_=>{_.inlineForm[0].click(!1)}),await q.post("order/put-design",m)}async function v(m){if(m.completeNbqPv=k("completeNbqPv","value"),!m.completeNbqPv){E("设计组串数量中DC1和DC2是必填、是非零项");return}await q.post(M("approval/put-approval/bto/design",m))}async function f(m){await q.post("approval/do-approval/bto/design",m)}return te({getData:s,saveData:o,submitData:v,approvalData:f}),(m,g)=>{const _=L,j=X,b=K,y=U("vxe-column"),I=R,A=U("vxe-table"),O=z,J=W;return $(),ce(ue,null,[n(b,{form:p(t).basicInfoForm,class:"pt-3","group-class":"shadowC"},{title:u(({slot:c})=>[n(j,{"title-class":"!text-[20px] bg-[#fff] pl-[20px] flex items-center  text-[#232323]",class:"!bg-[#fff] !p-0 h-[50px] !pr-[20px]"},{title:u(()=>[V(pe(c.title),1)]),value:u(()=>[de("div",xe,[c.show?($(),me(_,{key:0,round:"",block:"",size:"mini",class:"!text-[14px] !w-[120px] !py-3 !bg-[#ddd] !border-0 !text-[white]",onClick:()=>c.click()},{default:u(()=>[V(" 设计变更记录 ")]),_:2},1032,["onClick"])):ve("",!0)])]),_:2},1024)]),_:1},8,["form"]),n(b,{form:p(t).zj,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(b,{form:p(t).nbq,class:"pt-3","group-class":"shadowC pb-9"},{"table-nbq":u(({slot:c})=>[n(A,{data:c.value,align:"center","header-align":"center"},{default:u(()=>[n(y,{type:"seq",width:"60",title:"序号"}),n(y,{field:"deviceSpec",title:"规格型号"}),n(y,{field:"quantity",title:"个数",width:"60"}),n(y,{field:"",title:"操作",width:"60"},{default:u(({row:S})=>[n(I,{name:"cross",color:"red",onClick:Q=>c.remove(S)},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])]),_:1},8,["form"]),n(b,{form:p(t).cjq,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(b,{form:p(t).pdx,class:"pt-3","group-class":"shadowC pb-9"},{"table-pdx":u(({slot:c})=>[n(A,{data:c.value,align:"center","header-align":"center"},{default:u(()=>[n(y,{type:"seq",width:"60",title:"序号"}),n(y,{field:"deviceSpec",title:"规格型号"}),n(y,{field:"quantity",title:"个数",width:"60"}),n(y,{field:"",title:"操作",width:"60"},{default:u(({row:S})=>[n(I,{name:"cross",color:"red",onClick:Q=>c.remove(S)},null,8,["onClick"])]),_:2},1024)]),_:2},1032,["data"])]),_:1},8,["form"]),n(b,{form:p(t).structureChartForm,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(b,{form:p(t).electricalDiagramForm,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(b,{form:p(t).billMaterials,class:"pt-3","group-class":"shadowC"},null,8,["form"]),n(O,{show:p(t).show[0].value,"onUpdate:show":g[0]||(g[0]=c=>p(t).show[0].value=c),position:"right",class:"w-full h-full",closeable:""},{default:u(()=>[n(Y,{ref_key:"designGroupDom",ref:l,query:p(t).show[0].query},null,8,["query"])]),_:1},8,["show"]),n(J)],64)}}};export{tt as default};
